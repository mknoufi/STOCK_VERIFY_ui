name: SonarCloud Analysis

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  sonarcloud:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    # Note: SONAR_TOKEN availability is checked at step level, not job level

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis

      # ----- Python Backend Setup -----
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unixodbc-dev freetds-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov bandit ruff pylint

      - name: Run Python tests with coverage
        env:
          JWT_SECRET: test-jwt-secret-for-ci-testing-only
          JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci-testing-only
          MONGODB_URL: mongodb://localhost:27017
          TESTING: "true"
        run: |
          cd backend
          pytest tests/ -v --cov=. --cov-report=xml:coverage.xml --cov-report=term || true

      - name: Generate Bandit security report
        run: |
          cd backend
          bandit -r . -ll -f json -o bandit-report.json --exclude ./tests,./venv,./__pycache__ || true

      - name: Generate Ruff lint report
        run: |
          cd backend
          ruff check . --output-format=json > ruff-report.json || true

      # ----- Node.js Frontend Setup -----
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Run frontend tests with coverage
        run: |
          cd frontend
          npm run test:coverage -- --ci --reporters=default || true

      - name: Generate ESLint report
        run: |
          cd frontend
          npx eslint . --format json --output-file eslint-report.json || true

      # ----- SonarCloud Analysis -----
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Optional: Fail the pipeline if Quality Gate fails
      - name: SonarCloud Quality Gate check
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        if: success()
